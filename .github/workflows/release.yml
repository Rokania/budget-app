name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  APP_NAME: Budget
  SCHEME: Budget
  BUNDLE_ID: com.budget.app

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Resolve Dependencies
        run: xcodebuild -resolvePackageDependencies -project ${{ env.APP_NAME }}.xcodeproj

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version $VERSION"

      - name: Update version in Info.plist
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.version }}" ${{ env.APP_NAME }}/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ github.run_number }}" ${{ env.APP_NAME }}/Info.plist

      - name: Build Release
        run: |
          xcodebuild -project ${{ env.APP_NAME }}.xcodeproj \
            -scheme ${{ env.SCHEME }} \
            -configuration Release \
            -derivedDataPath build \
            -archivePath build/${{ env.APP_NAME }}.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Export App
        run: |
          mkdir -p export
          cp -R "build/${{ env.APP_NAME }}.xcarchive/Products/Applications/${{ env.APP_NAME }}.app" export/

      - name: Create ZIP
        run: |
          cd export
          zip -r -y "${{ env.APP_NAME }}-${{ steps.version.outputs.version }}.zip" "${{ env.APP_NAME }}.app"
          ls -la

      - name: Download Sparkle
        run: |
          curl -sL https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz -o /tmp/Sparkle.tar.xz
          cd /tmp && tar -xf Sparkle.tar.xz

      - name: Sign Update with EdDSA
        id: sign
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          echo "$SPARKLE_PRIVATE_KEY" | base64 -d > /tmp/sparkle_private_key
          SIGN_OUTPUT=$(/tmp/bin/sign_update "export/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}.zip" --ed-key-file /tmp/sparkle_private_key)
          echo "Sign output: $SIGN_OUTPUT"
          SIGNATURE=$(echo "$SIGN_OUTPUT" | grep -o 'edSignature="[^"]*"' | cut -d'"' -f2)
          if [ -z "$SIGNATURE" ]; then
            SIGNATURE=$(echo "$SIGN_OUTPUT" | tail -1)
          fi
          echo "Extracted signature: $SIGNATURE"
          echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
          SIZE=$(stat -f%z "export/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}.zip")
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          rm /tmp/sparkle_private_key

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: export/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}.zip
          generate_release_notes: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy appcast to gh-pages
        env:
          VERSION: ${{ steps.version.outputs.version }}
          SIGNATURE: ${{ steps.sign.outputs.signature }}
          SIZE: ${{ steps.sign.outputs.size }}
          RUN_NUMBER: ${{ github.run_number }}
          REPO: ${{ github.repository }}
          OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone --branch gh-pages --single-branch "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" gh-pages-dir
          cd gh-pages-dir
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo '<?xml version="1.0" encoding="utf-8"?>' > appcast.xml
          echo '<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">' >> appcast.xml
          echo '  <channel>' >> appcast.xml
          echo '    <title>Budget</title>' >> appcast.xml
          echo "    <link>https://${OWNER}.github.io/${REPO_NAME}/</link>" >> appcast.xml
          echo '    <description>Mises a jour de Budget</description>' >> appcast.xml
          echo '    <language>fr</language>' >> appcast.xml
          echo '    <item>' >> appcast.xml
          echo "      <title>Version ${VERSION}</title>" >> appcast.xml
          echo "      <pubDate>$(date -R)</pubDate>" >> appcast.xml
          echo "      <sparkle:version>${RUN_NUMBER}</sparkle:version>" >> appcast.xml
          echo "      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>" >> appcast.xml
          echo '      <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>' >> appcast.xml
          echo '      <description><![CDATA[' >> appcast.xml
          echo "        <h2>Nouveautes de la version ${VERSION}</h2>" >> appcast.xml
          echo '        <p>Consultez les notes de version sur GitHub.</p>' >> appcast.xml
          echo '      ]]></description>' >> appcast.xml
          echo '      <enclosure' >> appcast.xml
          echo "        url=\"https://github.com/${REPO}/releases/download/v${VERSION}/Budget-${VERSION}.zip\"" >> appcast.xml
          echo "        sparkle:edSignature=\"${SIGNATURE}\"" >> appcast.xml
          echo "        length=\"${SIZE}\"" >> appcast.xml
          echo '        type="application/octet-stream"/>' >> appcast.xml
          echo '    </item>' >> appcast.xml
          echo '  </channel>' >> appcast.xml
          echo '</rss>' >> appcast.xml

          git add appcast.xml
          git commit -m "Update appcast for v${VERSION}"
          git push origin gh-pages --force
